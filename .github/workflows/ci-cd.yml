name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feat/**'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Validar c√≥digo Go
  lint-and-test:
    name: Lint & Test Go Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: maestro
          POSTGRES_PASSWORD: maestro_pass
          POSTGRES_DB: maestro_test
        options: >-
          --health-cmd="pg_isready -U maestro"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
        ports:
          - 5432:5432

      rabbitmq:
        image: rabbitmq:3.13-management
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
          - 15672:15672

    env:
      DB_USER: maestro
      DB_PASSWORD: maestro_pass
      DB_NAME: maestro_test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_DSN: postgres://maestro:maestro_pass@localhost:5432/maestro_test?sslmode=disable
      MAESTRO_DB_HOST: localhost
      MAESTRO_DB_PORT: 5432
      MAESTRO_DB_USER: maestro
      MAESTRO_DB_PASSWORD: maestro_pass
      MAESTRO_DB_NAME: maestro_test
      MAESTRO_RABBITMQ_HOST: localhost
      MAESTRO_RABBITMQ_PORT: 5672
      MAESTRO_RABBITMQ_USER: guest
      MAESTRO_RABBITMQ_PASSWORD: guest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          for i in $(seq 1 30); do
            if pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" >/dev/null 2>&1; then
              echo "Postgres ready"
              exit 0
            fi
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done
          echo "Postgres did not become ready" >&2
          exit 1
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for RabbitMQ to be ready
        run: |
          for i in $(seq 1 30); do
            if nc -z "$MAESTRO_RABBITMQ_HOST" "$MAESTRO_RABBITMQ_PORT" >/dev/null 2>&1; then
              echo "RabbitMQ ready"
              exit 0
            fi
            echo "Waiting for RabbitMQ... ($i/30)"
            sleep 2
          done
          echo "RabbitMQ did not become ready" >&2
          exit 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Run go mod download
        run: go mod download

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå Go fmt issues found:"
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ Go fmt check passed"

      - name: Run go vet
        run: |
          echo "üîç Running go vet..."
          go vet ./...
          echo "‚úÖ go vet passed"

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

      - name: Build application
        run: |
          echo "üî® Building application..."
          CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o rps-maestro ./cmd/api
          echo "‚úÖ Build successful"

      - name: Run tests
        run: |
          echo "üß™ Running tests..."
          go test -v -race -coverprofile=coverage.out ./...
          echo "‚úÖ Tests passed"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Job 2: Build Docker image
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-test
    permissions:
      contents: read
      packages: write
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 3: Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: github.event_name == 'push'
        with:
          sarif_file: 'trivy-results.sarif'
          wait-for-processing: true

  # Job 4: Deploy (apenas para main branch e self-hosted)
  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: [lint-and-test, build-docker]
    permissions:
      contents: read
      packages: write
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://your-production-url.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: image
        run: |
          echo "tag=ghcr.io/${{ github.repository }}:sha-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Prepare deployment directory
        env:
          MAESTRO_ENV_FILE: ${{ secrets.MAESTRO_ENV_FILE }}
        run: |
          mkdir -p ${{ secrets.MAESTRO_DEPLOY_PATH }}
          cd ${{ secrets.MAESTRO_DEPLOY_PATH }}
          
          # Copia docker-compose de produ√ß√£o
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml ./docker-compose.yml
          echo "‚úÖ Docker Compose file copied"
          
          # Cria .env
          echo "$MAESTRO_ENV_FILE" > .env
          echo "IMAGE_TAG=sha-${{ github.sha }}" >> .env
          echo "‚úÖ .env file created successfully"

      - name: Deploy with Docker Compose
        working-directory: ${{ secrets.MAESTRO_DEPLOY_PATH }}
        run: |
          echo "üöÄ Pulling image: ${{ steps.image.outputs.tag }}"
          docker pull ${{ steps.image.outputs.tag }}
          
          echo "üöÄ Starting services..."
          docker-compose up -d --no-build
          
          echo "‚úÖ Deployment completed"

      - name: Health check
        run: |
          echo "üè• Waiting for application..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/v1/health 2>/dev/null; then
              echo "‚úÖ Application is healthy"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "‚ùå Health check failed"
          exit 1

      - name: Cleanup old images
        if: always()
        run: |
          echo "üßπ Cleaning up old Docker images..."
          docker image prune -af --filter "until=72h"
          echo "‚úÖ Cleanup completed"

  # Job 5: Notify on failure
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: failure()
    needs: [lint-and-test, build-docker, security-scan]
    
    steps:
      - name: Send failure notification
        run: |
          echo "‚ùå Pipeline failed!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # Job 6: Comment on PR with results
  pr-comment:
    name: Comment PR Results
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    if: always() && github.event_name == 'pull_request'
    needs: [lint-and-test, build-docker, security-scan]
    
    steps:
      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const getStatus = (result) => {
              if (result === 'success') return '‚úÖ Passed';
              if (result === 'failure') return '‚ùå Failed';
              if (result === 'cancelled') return 'üö´ Cancelled';
              return '‚è≠Ô∏è Skipped';
            };
            
            const lintStatus = getStatus('${{ needs.lint-and-test.result }}');
            const buildStatus = getStatus('${{ needs.build-docker.result }}');
            const securityStatus = getStatus('${{ needs.security-scan.result }}');
            
            const comment = `## CI/CD Pipeline Results
            
            | Check | Status |
            |-------|--------|
            | Lint & Tests | ${lintStatus} |
            | Docker Build | ${buildStatus} |
            | Security Scan | ${securityStatus} |
            
            [View full workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
